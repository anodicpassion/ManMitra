<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Lexend:wght@300;400;600;700;900&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --primary-color: #137fec;
        }
        body {
            font-family: 'Lexend', sans-serif;
        }
    </style>
    <style>
        body {
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        .progress-circle {
            position: relative;
            width: 180px;
            height: 180px;
        }

        @media (min-width: 640px) {
            .progress-circle {
                width: 200px;
                height: 200px;
            }
        }

        .progress-ring {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-circle {
            stroke-dasharray: 628.318; /* 2 * PI * 100 */
            stroke-dashoffset: 628.318;
            transition: stroke-dashoffset 2s ease-in-out;
            stroke-linecap: round;
        }

        .curve-divider {
            position: relative;
            height: 60px;
            overflow: hidden;
            margin-bottom: -60px;
        }

        @media (min-width: 640px) {
            .curve-divider {
                height: 80px;
                margin-bottom: -80px;
            }
        }

        .curve-divider::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            border-radius: 0 0 50% 50% / 0 0 100% 100%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 1s ease-out forwards;
        }

        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
        .stagger-4 { animation-delay: 0.4s; }

        /* Prevent zooming on input focus */
        input, textarea, select {
            font-size: 16px !important;
        }

        /* Fix for mobile input styling */
        input[type="number"], textarea {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        /* Ensure proper touch targets */
        button, input[type="submit"], a {
            min-height: 44px;
            min-width: 44px;
        }

        /* Safe area for devices with notches */
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }

        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="relative flex h-auto min-h-screen w-full flex-col text-white dark justify-between group/design-root">
        <!-- Top Section with Contrast Background -->
        <div class="bg-[#1a1a2e] relative">
            <header class="flex items-left p-4 justify-left sticky top-0 bg-[#1a1a2e]/80 backdrop-blur-sm z-10 safe-area-top">
                <span class="material-symbols-outlined text-[var(--primary-color)] mr-2">spa</span>
                <h2 class="text-xl font-semibold tracking-tight text-white">ManMitra</h2>
            </header>

            <div class="flex flex-col items-center px-4 sm:px-6 pt-4 sm:pt-6 pb-0">
                <!-- Greeting Section -->
                <div class="text-center mb-6 sm:mb-8">
                    <h1 class="text-xl sm:text-2xl font-light tracking-tight text-white">{{ greeting }}</h1>
                    <h2 class="text-3xl sm:text-4xl font-bold text-[var(--primary-color)] break-words">{{ current_user.username }}!</h2>
                </div>

                <!-- Central Progress Circle -->
                <div class="flex flex-col items-center mb-6 sm:mb-8">
                    <div class="progress-circle">
                        <svg class="progress-ring" viewBox="0 0 220 220">
                            <!-- Background circle -->
                            <circle
                                cx="110"
                                cy="110"
                                r="100"
                                stroke="#374151"
                                stroke-width="8"
                                fill="transparent"
                            />
                            <!-- Progress circle -->
                            <circle
                                cx="110"
                                cy="110"
                                r="100"
                                stroke="url(#gradient)"
                                stroke-width="8"
                                fill="transparent"
                                class="progress-ring-circle"
                                id="progress-circle"
                            />
                            <!-- Gradient definition -->
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#137fec;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                        </svg>
                        <!-- Center content -->
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-3xl sm:text-4xl font-bold text-[var(--primary-color)]" id="average-mood">0</span>
                            <span class="text-xs sm:text-sm text-gray-300 mt-1">Average Mood</span>
                            <span class="text-xs text-gray-400 mt-1">Last 7 days</span>
                        </div>
                    </div>
                </div>

                <!-- Weekly Progress Indicators -->
                <div class="flex gap-2 sm:gap-3 mb-6 sm:mb-8" id="weekly-indicators">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Curve Divider -->
            <div class="curve-divider"></div>
        </div>


        <!-- Bottom Section with Original Background -->
        <div class="bg-[#0d1117] flex-grow pb-20">
            <br>
            <br>
            <br>
            <main class="flex flex-col gap-4 sm:gap-6 px-4 sm:px-6 pt-6 sm:pt-8 pb-6 sm:pb-8 text-white max-w-2xl mx-auto">
                <!-- Daily Check-in -->
                <div class="w-full bg-white/5 rounded-xl p-4 sm:p-6 shadow-lg shadow-black/20 fade-in-up stagger-1" style="opacity: 0;">
                    <h3 class="text-lg font-semibold tracking-tight mb-4">Daily Check-in</h3>
                    {% if not mood_today %}
                        <form method="post" action="{{ url_for('checkin') }}" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2" for="mood">Mood (1-10)</label>
                                <input class="w-full bg-white/10 border border-white/20 rounded-md text-white focus:ring-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] p-3 text-base" name="mood" type="number" min="1" max="10" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2" for="note">Note (optional)</label>
                                <textarea class="w-full bg-white/10 border border-white/20 rounded-md text-white focus:ring-2 focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] p-3 resize-none h-24 text-base" name="note" placeholder="How are you feeling today?"></textarea>
                            </div>
                            <input type="submit" value="Submit Check-in" class="w-full bg-[var(--primary-color)] text-white rounded-md p-3 hover:bg-[var(--primary-color)]/80 transition-colors cursor-pointer font-medium text-base min-h-[48px]">
                        </form>
                    {% else %}
                        <p class="text-gray-300 text-base leading-relaxed">Today's Mood: {{ mood_today.mood_score }}/10 - {{ mood_today.note }}</p>
                    {% endif %}
                </div>

                <!-- Motivational Quote -->
                <div class="w-full bg-white/5 rounded-xl p-4 sm:p-6 shadow-lg shadow-black/20 fade-in-up stagger-2" style="opacity: 0;">
                    <h3 class="text-lg font-semibold tracking-tight mb-4">Motivational Quote</h3>
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 bg-[var(--primary-color)]/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                            <span class="material-symbols-outlined text-[var(--primary-color)] text-sm">format_quote</span>
                        </div>
                        <p class="text-gray-300 text-base leading-relaxed">{{ quote }}</p>
                    </div>
                </div>

                <!-- Mood Progress Table -->
                <div class="w-full bg-white/5 rounded-xl p-4 sm:p-6 shadow-lg shadow-black/20 fade-in-up stagger-3" style="opacity: 0;">
                    <h3 class="text-lg font-semibold tracking-tight mb-4">Mood Progress (Last 7 Days)</h3>
                    <div class="overflow-x-auto -mx-2 px-2">
                        <table class="w-full bg-transparent rounded-lg border border-white/10 min-w-[280px]">
                            <thead>
                                <tr class="text-gray-300">
                                    <th class="p-3 text-left text-sm font-medium">Date</th>
                                    <th class="p-3 text-left text-sm font-medium">Mood Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for date, score in mood_list %}
                                    <tr class="border-t border-white/10">
                                        <td class="p-3 text-sm">{{ date }}</td>
                                        <td class="p-3 text-sm">{{ score }}/10</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Daily Tip -->
                <div class="w-full bg-white/5 rounded-xl p-4 sm:p-6 shadow-lg shadow-black/20 fade-in-up stagger-4" style="opacity: 0;">
                    <h3 class="text-lg font-semibold tracking-tight mb-4">Daily Tip</h3>
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 bg-[var(--primary-color)]/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                            <span class="material-symbols-outlined text-[var(--primary-color)] text-sm">lightbulb</span>
                        </div>
                        <p class="text-gray-300 text-base leading-relaxed">{{ tip }}</p>
                    </div>
                </div>
            </main>
        </div>


        <footer class="fixed bottom-0 w-full bg-[#0d1117]/80 backdrop-blur-sm z-10">
            <div class="flex items-center justify-around border-t border-white/10 p-2">
                <a class="flex flex-col items-center justify-center gap-1.5 py-2 px-4 rounded-full text-[var(--primary-color)]" href="/">

                    <span class="material-symbols-outlined">spa</span>
                </a>
                <a class="flex flex-col items-center justify-center gap-1.5 py-2 px-4 rounded-full text-gray-400 hover:text-white transition-colors" href="{{ url_for('chat_page') }} ">
                    <span class="material-symbols-outlined">auto_stories</span>
                </a>
                <a class="flex flex-col items-center justify-center gap-1.5 py-2 px-4 rounded-full text-gray-400 hover:text-white transition-colors" href="{{ url_for('community') }}">
                    <span class="material-symbols-outlined">groups</span>
                </a>
                <a class="flex flex-col items-center justify-center gap-1.5 py-2 px-4 rounded-full text-gray-400 hover:text-white transition-colors" href="{{ url_for('profile') }}">
                    <span class="material-symbols-outlined">person</span>
                </a>
            </div>
        </footer>
    </div>

    <script>
        // Calculate mood average and animate progress circle
        window.addEventListener('load', function() {
            // Extract mood data from the table (backend data)
            const moodRows = document.querySelectorAll('tbody tr');
            let totalMood = 0;
            let moodCount = 0;
            const moodData = [];

            moodRows.forEach(row => {
                const dateText = row.cells[0].textContent.trim();
                const scoreText = row.cells[1].textContent.trim().replace('/10', '');
                const score = parseInt(scoreText);
                if (!isNaN(score)) {
                    totalMood += score;
                    moodCount++;
                    moodData.push({
                        date: dateText,
                        score: score
                    });
                }
            });

            // Calculate average mood
            const averageMood = moodCount > 0 ? (totalMood / moodCount).toFixed(1) : 0;
            document.getElementById('average-mood').textContent = averageMood;

            // Create weekly indicators based on actual check-in dates
            const weeklyIndicators = document.getElementById('weekly-indicators');

            // Generate last 7 days for comparison
            const today = new Date();
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                last7Days.push(date);
            }

            // Create indicators for each of the last 7 days
            last7Days.forEach((date, index) => {
                const indicator = document.createElement('div');
                indicator.className = 'flex flex-col items-center';

                // Format date to match your backend format
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const formattedDate = `${monthNames[date.getMonth()]} ${date.getDate()}`;

                // Try different date formats that might match your backend
                const altFormats = [
                    formattedDate,
                    `${date.getMonth() + 1}/${date.getDate()}`,
                    `${date.getDate()}`,
                    `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
                ];

                // Find matching mood data
                let dayMood = null;
                for (const format of altFormats) {
                    dayMood = moodData.find(mood => mood.date === format);
                    if (dayMood) break;
                }

                const score = dayMood ? dayMood.score : 0;
                const opacity = score > 0 ? Math.max(0.3, score / 10) : 0.2;

                // Get day name
                const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                const dayName = dayNames[date.getDay()];

                indicator.innerHTML = `
                    <div class="w-3 h-3 sm:w-4 sm:h-4 bg-[var(--primary-color)] rounded-full mb-1" style="opacity: ${opacity}" title="${formattedDate}: ${score || 'No data'}/10"></div>
                    <span class="text-xs text-gray-300">${dayName}</span>
                `;

                weeklyIndicators.appendChild(indicator);
            });

            // Animate progress circle
            if (averageMood > 0) {
                const progress = (averageMood / 10) * 100;
                const circumference = 2 * Math.PI * 100;
                const offset = circumference - (progress / 100) * circumference;

                setTimeout(() => {
                    document.getElementById('progress-circle').style.strokeDashoffset = offset;
                }, 500);
            }

            // Animate cards with stagger
            setTimeout(() => {
                document.querySelectorAll('.fade-in-up').forEach(el => {
                    el.style.opacity = '1';
                });
            }, 1000);
        });

        // Prevent zoom on iOS when focusing inputs
        document.addEventListener('touchstart', function() {}, true);
    </script>
</body>
</html>